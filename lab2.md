# lab2: CAN Bus and Multitasking

## Objectives
Objectives
- Learn the mbed CAN API and the basic underlying principles/
- Learn about and use the different multitasking models on a CAN node.

## Introduction
[CAN (Controller Area Network)](https://en.wikipedia.org/wiki/CAN_bus) is a communications standard used to network electronics in vehicles, including our solar car. While commercial vehicles also have other network standards to choose from (and some may use a combination of several), all the networked devices (including battery management system, motor controller, telemetry, MPPT) on our car communicate over a shared CAN bus.

### Interface Level
A CAN bus consists of at least two devices (nodes) connected to a shared bus, and is a _message-based_, _broadcast_ network:
- Message-based: transmissions occur in complete messages (also called frames).
- Broadcast: all nodes on the network can hear the transmissions of any node (though they need not act on irrelevant messages).

### Message Format
CAN messages carry these pieces of user data:
- ID field, either 11 bits (standard frame) or 29 bits (extended frame). A lower ID gives the message priority in the event of a collision (multiple nodes start transmitting simultaneously).
- Data, up to 8 bytes. The length is transmitted as part of the frame.
- Remote transmission request (RTR), one bit, which marks this as a remote request frame, as opposed to a data frame.

The ID field is used to indicate the kind of data being transmitted (for example, "battery voltage") and the data contains the actual data (continuing the example, 107.4 V encoded as 2 bytes fixed point). Message IDs must be unique on any single CAN bus. Because of the priority system, giving a lower ID to more important messages (or messages with stricter deadlines) is recommended.

Usually, nodes transmit data regularly (for example, battery voltage is automatically sent every second by the BMS), but the RTR field can be used to request specific data. Responding to RTR messages must be handled by application code, and it's not something we use.

CAN also provides these non-user data fields:
- [Cyclic Redundancy Check (CRC)](https://en.wikipedia.org/wiki/Cyclic_redundancy_check), 15 bits, as a checksum so corrupted messages are discarded.
- Acknowledgement, one bit, asserted by any other node upon successful reception (including CRC check).
  - If a message is not acknowledged by any other node, the transmitter will retransmit it.
  - However, it is impossible to tell from the acknowledgement bit if a message was received by a particular node.
  - As acknowledgements are generated by the CAN controller peripheral, before higher-level application processing.

### Errors
CAN controllers keep count of errors, and too many errors may result in a _bus-off_ condition, where the controller disconnects from the bus. The CAN controller must be re-initialized (through user-level code) before communications can resume. The full list of error counter rules is complex and a more detailed explanation is [here](https://www.kvaser.com/about-can/the-can-protocol/can-error-handling/).

### Physical Layer
_This is only a very high-level overview._

The CAN bus itself consists of two wires, CANH and CANL as a differential pair, to which all nodes are attached. There are two bit levels, either dominant (0) or recessive (1). When multiple nodes transmit simultaneously (collision), a dominant bit takes priority over a recessive bit (the mechanism for ID-based arbitration). If no node is transmitting, the bus is held at a recessive level.

The CAN controller operates on two different, single-ended (non-differential), logic-level lines: TXD and RXD. RXD indicates the current bit level on the CANH/CANL lines, while TXD indicates the bit to transmit.

A CAN transceiver bridges the logic-level TXD/RXD lines and the bus-level CANH/CANL lines. While CAN controllers may be a on-chip peripheral on some microcontrollers, CAN transceivers are usually separate chips and may provide some degree of electrical isolation.

## Lab 2.1: Getting Started: Hardware
Hook up a pin to

Note: the example solutions use P0_28 for RXD and P0_29 for TXD.

## Lab 2.2: Sending CAN Messages
Transmit a CAN message on a button press, which pulses a remote LED. Sketch for edge detection also provided.

## Lab 2.3: Receiving CAN Messages
Receive a message with a particular ID which sets the
